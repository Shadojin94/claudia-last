(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))c(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&c(r)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function c(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}})();const e={recognition:null,isListening:!1,isActiveMode:!1,isAISpeaking:!1,conversationHistory:[],animationFrameId:null,sessionStartTime:null,sessionDuration:0,isAlwaysOn:!0,isPaused:!1,retryCount:0},t={canvas:document.getElementById("spectre"),listenCircle:document.getElementById("listenCircle"),statusText:document.getElementById("statusText"),aiResponseElement:document.getElementById("aiResponse"),timerElement:document.getElementById("timer"),audioPlayer:document.getElementById("audioPlayer"),pauseButton:document.getElementById("pauseButton"),activeListenButton:document.getElementById("activeListenButton"),uploadButton:document.getElementById("uploadButton"),fileUpload:document.getElementById("fileUpload"),datetimeElement:document.getElementById("datetime"),downloadModal:document.getElementById("downloadModal"),confirmDownloadButton:document.getElementById("confirmDownload"),cancelDownloadButton:document.getElementById("cancelDownload")};function l(o,n=1){t.statusText.textContent=o,t.statusText.style.opacity=n}function E(){const o=new Date;t.datetimeElement.textContent=o.toLocaleString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}function P(){if(!e.sessionStartTime)return;const o=Date.now()-e.sessionStartTime,n=Math.floor(o/6e4),s=Math.floor(o%6e4/1e3);t.timerElement.textContent=`${String(n).padStart(2,"0")}:${String(s).padStart(2,"0")}`}function w(){const o=t.canvas.getContext("2d");t.canvas.width=t.canvas.offsetWidth,t.canvas.height=t.canvas.offsetHeight;const n=t.canvas.width/2,s=t.canvas.height/2,c=Math.min(n,s)-5;let i=0;function a(){o.clearRect(0,0,t.canvas.width,t.canvas.height);for(let r=0;r<360;r+=2){const p=r*Math.PI/180,y=c*(.5+Math.random()*.5),u=n+y*Math.cos(p),g=s+y*Math.sin(p);o.beginPath(),o.moveTo(n,s),o.lineTo(u,g),o.strokeStyle=`hsla(${(i+r)%360}, 100%, 50%, 0.5)`,o.lineWidth=2,o.stroke()}i=(i+1)%360,e.animationFrameId=requestAnimationFrame(a)}a()}function v(){e.animationFrameId&&cancelAnimationFrame(e.animationFrameId),t.canvas.getContext("2d").clearRect(0,0,t.canvas.width,t.canvas.height)}const f={OPENAI_API_KEY:"OPENAI_API_KEY",SYSTEM_MESSAGE:"Tu es Claudia, une IA conversationnelle française pleine d'esprit. Tu es directe, drôle et naturelle dans tes réponses.",SPEECH_RECOGNITION_TIMEOUT:5e3,MAX_RETRY_ATTEMPTS:3,GPT_MODEL:"gpt-4o-mini"};async function L(o){try{const n=await fetch("https://api.openai.com/v1/audio/speech",{method:"POST",headers:{Authorization:`Bearer ${f.OPENAI_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({model:"tts-1",input:o,voice:"nova"})});if(!n.ok)throw new Error(`Erreur HTTP: ${n.status}`);const s=await n.blob(),c=URL.createObjectURL(s);if(t.audioPlayer.src=c,t.audioPlayer.onended=h,e.isAISpeaking=!0,w(),!e.isPaused)try{await t.audioPlayer.play()}catch(i){console.error("Erreur de lecture audio:",i),S(o)}}catch(n){console.error("Erreur de synthèse vocale:",n),S(o)}}function S(o){if("speechSynthesis"in window){const n=new SpeechSynthesisUtterance(o);n.lang="fr-FR",n.onend=h,window.speechSynthesis.speak(n)}else console.error("Aucune synthèse vocale disponible"),h()}function C(o){const n=o.target.files[0];if(n){const s=new FileReader;s.onload=function(c){try{const i=JSON.parse(c.target.result);if(i.history&&Array.isArray(i.history)){e.conversationHistory=i.history,l("Contexte chargé avec succès");const a=A(e.conversationHistory);T(`Contexte chargé : ${a}. Continue naturellement.`)}else throw new Error("Format de fichier invalide")}catch(i){console.error("Erreur:",i),l("Erreur de chargement du fichier")}},s.readAsText(n)}}function M(){const o={timestamp:new Date().toISOString(),history:e.conversationHistory},n=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download=`conversation_${new Date().toISOString().replace(/[:.]/g,"-")}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s)}function A(o){return o.length?o.slice(-5).map(s=>`${s.role==="user"?"Utilisateur":"Claudia"}: ${s.content.substring(0,50)}...`).join(" | "):"Aucun contexte disponible"}function B(o){const n=o.toLowerCase();return n.includes("mec")||n.includes("cool")||n.includes("genre")?"casual":n.includes("monsieur")||n.includes("madame")||n.includes("veuillez")?"formal":"neutral"}async function T(o){l("Réflexion en cours...",.3),t.aiResponseElement.textContent="";const s=new Date().toLocaleString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),c=B(o),i=A(e.conversationHistory),a=`${f.SYSTEM_MESSAGE}

La date et l'heure actuelles sont : ${s}
Style de langage détecté : ${c}. Adaptez votre réponse en conséquence.

Résumé du contexte : ${i}`;try{const[r,p]=await Promise.all([fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f.OPENAI_API_KEY}`},body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"system",content:a},...e.conversationHistory.slice(-10),{role:"user",content:o}]})}),fetch("https://api.openai.com/v1/audio/speech",{method:"POST",headers:{Authorization:`Bearer ${f.OPENAI_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({model:"tts-1",input:"Réponse en cours de génération...",voice:"nova"})})]);if(!r.ok||!p.ok)throw new Error(`Erreur HTTP: ${r.status} ou ${p.status}`);const u=(await r.json()).choices[0].message.content;e.conversationHistory.push({role:"user",content:o}),e.conversationHistory.push({role:"assistant",content:u}),l("Claudia répond..."),t.aiResponseElement.textContent=u;const g=u.match(/https?:\/\/[^\s]+/);g&&window.open(g[0],"_blank"),await L(u)}catch(r){console.error("Erreur lors de la communication avec l'IA:",r),l(`Erreur: ${r.message}`)}}function I(){if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window))return console.log("Reconnaissance vocale non supportée"),l("Veuillez utiliser Safari sur iOS ou Chrome/Edge sur desktop"),null;const o=window.SpeechRecognition||window.webkitSpeechRecognition,n=new o;return n.continuous=!1,n.interimResults=!1,n.lang="fr-FR",n.onstart=()=>{l("Je vous écoute..."),e.sessionStartTime||(e.sessionStartTime=Date.now()),w()},n.onresult=s=>{const c=s.results[0][0].transcript;c.trim()?(e.retryCount=0,T(c)):R()},n.onend=()=>{e.isListening=!1,e.isActiveMode&&!e.isAISpeaking&&!e.isPaused?setTimeout(()=>{e.isActiveMode&&!e.isAISpeaking&&!e.isPaused&&d()},100):m()},n.onerror=s=>{console.error("Erreur de reconnaissance vocale:",s.error),m(),l("Erreur de reconnaissance vocale. Réessayez.")},n}function d(){if(!(e.isAISpeaking||e.isPaused||e.isListening)){e.recognition||(e.recognition=I());try{e.isListening=!0,t.listenCircle.style.borderColor="#ff4136",e.recognition.start()}catch(o){console.error("Erreur lors du démarrage de la reconnaissance vocale:",o),m(),setTimeout(d,100)}}}function m(){if(e.recognition)try{e.recognition.stop()}catch(o){console.error("Erreur lors de l'arrêt de la reconnaissance vocale:",o)}e.isListening=!1,t.listenCircle.style.borderColor="#00c48c",v(),!e.isActiveMode&&!e.isPaused&&l("Appuyez ici pour parler")}function h(){t.audioPlayer.pause(),t.audioPlayer.currentTime=0,e.isAISpeaking=!1,v(),e.isActiveMode&&!e.isPaused?setTimeout(d,100):l("Appuyez ici pour parler")}function R(){e.retryCount<f.MAX_RETRY_ATTEMPTS?(e.retryCount++,d()):(e.retryCount=0,m(),l("Aucune parole détectée"))}function O(){e.isAISpeaking?h():e.isListening||d()}function b(){e.isPaused||(e.isActiveMode=!e.isActiveMode,t.activeListenButton.classList.toggle("active",e.isActiveMode),e.isActiveMode&&!e.isListening&&!e.isAISpeaking?d():e.isActiveMode||m())}function k(){e.isPaused=!e.isPaused,t.pauseButton.classList.toggle("active",e.isPaused),e.isPaused?(m(),v(),t.audioPlayer.pause(),t.downloadModal.style.display="block"):(e.isActiveMode&&d(),e.isAISpeaking&&t.audioPlayer.play())}function x(){e.recognition||(e.recognition=I()),t.listenCircle.addEventListener("click",O),t.activeListenButton.addEventListener("click",b),t.pauseButton.addEventListener("click",k),t.uploadButton.addEventListener("click",()=>t.fileUpload.click()),t.fileUpload.addEventListener("change",C),t.confirmDownloadButton.addEventListener("click",()=>{M(),t.downloadModal.style.display="none"}),t.cancelDownloadButton.addEventListener("click",()=>{t.downloadModal.style.display="none"}),E(),setInterval(E,6e4),setInterval(P,1e3),window.addEventListener("resize",()=>{t.canvas&&(t.canvas.width=t.canvas.offsetWidth,t.canvas.height=t.canvas.offsetHeight)})}window.addEventListener("load",x);
